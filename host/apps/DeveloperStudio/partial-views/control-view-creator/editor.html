<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link
            rel="stylesheet"
            data-name="vs/editor/editor.main"
            href="./node_modules/monaco-editor/min/vs/editor/editor.main.css"
        />
    </head>
    <body>
        <div
            id="container"
            style="width: 100%; height: 300px;"
        ></div>
        <script>
            var require = { paths: { vs: './node_modules/monaco-editor/min/vs' } };
        </script>
        <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
        <script src="./node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
        <script src="./node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>
        <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>
        <script src="./qtQuick.js" type="text/javascript"></script>
        <script type="text/javascript">
        new QWebChannel(qt.webChannelTransport, function(channel) {
            // all published objects are available in channel.objects under
            // the identifier set in their attached WebChannel.id property
            var link = channel.objects.valueLink;

            link.setValue.connect(function(value) {
                editor.setValue(value);
            });

            link.setContainerHeight.connect(function(height) {
                document.getElementById("container").setAttribute("style", `height:${height}px`);
                editor.layout()
            });

            link.setContainerWidth.connect(function(width) {
                document.getElementById("container").setAttribute("style", `width:${width}px`);
                editor.layout()
            });

            link.undo.connect(function() {
                editor.trigger('undoClicked', 'undo');
            });

            link.redo.connect(function() {
                editor.trigger('redoClicked', 'redo');
            });

            editor.getModel().onDidChangeContent((event) => {
                link.fileText = editor.getValue();
                link.setVersionId(editor.getModel().getAlternativeVersionId());
            });
        });
        </script>

        <script>
           monaco.languages.register({ id: 'qml' })

            monaco.languages.setMonarchTokensProvider('qml',{
                tokenizer: {
                    root: [
                        [/(?:\r\n|\n|^)(?:[^'"])*?(?:'(?:[^\r\n\\']|\\'|[\\]{2})*'|"(?:[^\r\n\\"]|\\"|[\\]{2})*")*?(?:[^'"])*?(\/\*(?:[\s\S]*?)\*\/|\/\/.*)/ ,'comment'],
                        [/\b(import)\s+/, 'import-statement'],
                        [/([\w\d\.]+)\s+(\d+\.\d+)(?:\s+(as)\s+([A-Z][\w\d]*))?/, 'namespace'],
                        [/(\"[^\"]+\")(?:\s+(as)\s+([A-Z][\w\d]*))?/, 'dirjs'],
                        [/(((^|\{)\s*)|\b)on[A-Z]\w*\b/,'on-handler'],
                        [/(?:^|\{)\s*(id)\s*\:\s*([^;\s]+)\b/,'meta-handler'],
                        [/^\s*(?:(default|readonly)\s+)?(property)\s+(?:(alias)|([\w\&lt;\&gt;]+))\s+(\w+)/, 'property-def'],
                        [/\b(signal)\s+(\w+)\s/,'signal-def'],
                        [/;|(?=\/)|$/,'signal-handler'],
                        [/(\w+)\s+(\w+)/,'signal-params'],
                        [/(?:\b|\s+)(?:(true|false|null|undefined)|(var|void|const|let)|(as|enum|connect|break|case|catch|continue|debugger|default|delete|do|else|finally|for|if|in|instanceof|new|return|switch|this|throw|try|typeof|while|with))\b/, 'js-def'],
                        [/\b(function)\s+([\w_]+)\s*(?=\()/, 'function-handler'],
                        [/\b[\w_]+\s*(?=\()/,'func-call'],
                        [/(?:^|\{|;)\s*[a-z][\w\.]*\s*(?=\:)/,'prop-def'],
                        [/(?:\&lt;=\.)\b\w*/,'var-name'],
                        [/\b([A-Za-z_]\w*)\b/,'assumed-variable']
                    ]
                }
            })

            monaco.languages.registerCompletionItemProvider('qml',{
                provideCompletionItems: () => {
                    var suggestions = []
                    for( var i = 0; i < qtQuick.length; i++){
                        suggestions.push({
                            label: qtQuick[i].prefix,
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            insertText: qtQuick[i].body,
                            documentation: qtQuick[i].description
                        })
                    }

                    for (var j = 0; j < qtQuickBody.length; j++){
                        suggestions.push({
                            label: qtQuickBody[j].prefix,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            insertText: qtQuickBody[j].body,
                            documentation: qtQuickBody[j].description
                        })
                    }
                    return {suggestions: suggestions}
                }
            })

            monaco.editor.defineTheme('qmlTheme',{
                base:'vs',
                inherit: false,
                rules:[
                    {token: 'comment', foreground: '#32C132'},
                    {token: 'import-statement', foreground: '#C6CC18'},
                    {token: 'namespace', foreground: '#AB0033'},
                    {token: 'dirjs', foreground: '#67CF0C'},
                    {token: 'on-handler',foreground: '#D41142'},
                    {token: 'meta-handler', foreground: '#D41142'},
                    {token: 'property-def', foreground: '#C6CC18'},
                    {token: 'signal-def', foreground: '#C6CC18'},
                    {token: 'signal-handler', foreground: '#000000'},
                    {token: 'signal-params', foreground: '#000000'},
                    {token: 'js-def', foreground: '#C6CC18'},
                    {token: 'function-handler', foreground: '#C6CC18'},
                    {token: 'func-call', foreground: '#000000'},
                    {token: 'prop-def', foreground: '#D41142'},
                    {token: 'var-name', foreground: '#000000', fontStyle: 'italic'},
                    {token: 'assumed-variable', foreground: "#000000", fontStyle: 'italic'},
                ]
            })

            var editor = monaco.editor.create(document.getElementById('container'), {
                value: "",
                language: 'qml',
                theme: "qmlTheme",
                insertSpaces: true,
                detectIndentation: false
            });

            function getValue() {
                return editor.getValue();
            }

            function setValue(value) {
                editor.setValue(value)
            }
            
        </script>
    </body>
</html>
